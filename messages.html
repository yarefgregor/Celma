<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dating Place - Messages</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar">
    <span class="menu-icon" id="menuBtn">&#9776;</span>
    <span class="nav-title">Dating Place</span>
  </nav>
  <div class="container">
  <header>
      <h1 class ="date">Dating Place</h1>
      <p class="site-desc">Access your chats privately with your password.</p>
    </header>
  
  
    <div class="toggle-section">
      <button id="friendsBtn" class="toggle-btn" onclick="window.location.href='home.html'">Friends</button>
      <button id="messagesBtn" class="toggle-btn active">Messages</button>
    </div>
    <!-- Messages Panel -->
    <div id="messagesPanel" class="card messages-style">
      <h2>Your Messages</h2>
      <div id="allChats" class="chat-list"></div>
    </div>
  </div>
  <!-- Hamburger Menu -->
  <div id="sideMenu" class="side-menu">
    <button id="homeBtn">üè† Home</button>
    <button id="settingsBtn">‚öôÔ∏è Settings</button>
    <button id="logoutBtn">üö™ Logout</button>
  </div>
  <!-- Message Popup -->
  <div id="messagePopup" class="popup hidden">
    <div class="popup-content">
      <span id="closeMsgBtn" class="close">&times;</span>
      <h3>Messages with <span id="msgUser"></span></h3>
      <div id="msgHistory" class="msg-history"></div>
      <form id="msgForm">
        <input type="text" id="msgInput" placeholder="Type a message..." required>
        <button type="submit">Send</button>
      </form>
      <button id="deleteChatBtn" class="delete-chat-btn">Delete Chat</button>
    </div>
  </div>
 
  <a class="contact-link" href="mailto:manthalukelvin@gmail.com?subject=Contact%20Support%20-%20D-Journal">Contact us</a>
  <script>
    // Utility functions
    function getUsers() {
      return JSON.parse(localStorage.getItem('datingplace_users') || '[]');
    }
    function setUsers(users) {
      localStorage.setItem('datingplace_users', JSON.stringify(users));
    }
    function getCurrentUser() {
      return JSON.parse(localStorage.getItem('datingplace_current_user') || 'null');
    }
    function setCurrentUser(user) {
      localStorage.setItem('datingplace_current_user', JSON.stringify(user));
    }
    function getMessages() {
      return JSON.parse(localStorage.getItem('datingplace_messages') || '{}');
    }
    function setMessages(msgs) {
      localStorage.setItem('datingplace_messages', JSON.stringify(msgs));
    }
    function emoji(gender) {
      return gender === 'female' ? 'üë©' : 'üë®';
    }
    function logout() {
      localStorage.removeItem('datingplace_current_user');
      window.location.href = 'index.html';
    }

    // MESSAGES.HTML LOGIC (Messages Page)
    if (document.getElementById('allChats')) {
      const user = getCurrentUser();
      if (!user) logout();
      // Hamburger menu logic
      const menuBtn = document.getElementById('menuBtn');
      const sideMenu = document.getElementById('sideMenu');
      menuBtn.onclick = () => sideMenu.classList.toggle('open');
      document.getElementById('homeBtn').onclick = () => { window.location.href = 'home.html'; };
      document.getElementById('settingsBtn').onclick = () => { window.location.href = 'settings.html'; };
      document.getElementById('logoutBtn').onclick = () => logout();

      // Messaging popup logic (used in both pages)
      window.openMsgPopup = function(phone) {
        const msgPopup = document.getElementById('messagePopup');
        const msgUser = getUsers().find(u => u.phone === phone);
        msgPopup.classList.remove('hidden');
        document.getElementById('msgUser').textContent = msgUser ? msgUser.nickname : phone;
        const msgHistoryDiv = document.getElementById('msgHistory');
        const messages = getMessages();
        const user = getCurrentUser();
        const chatId = [user.phone, phone].sort().join('_');
        let chat = messages[chatId] || [];
        msgHistoryDiv.innerHTML = '';
        chat.forEach(m => {
          const div = document.createElement('div');
          div.className = 'msg-bubble' + (m.from === user.phone ? ' me' : '');
          div.textContent = m.text;
          msgHistoryDiv.appendChild(div);
        });
        // Send message
        document.getElementById('msgForm').onsubmit = function(e) {
          e.preventDefault();
          const text = document.getElementById('msgInput').value.trim();
          if (!text) return;
          chat.push({ from: user.phone, to: phone, text, time: new Date().toISOString() });
          messages[chatId] = chat;
          setMessages(messages);
          document.getElementById('msgInput').value = '';
          openMsgPopup(phone);
          if (typeof loadChats === "function") loadChats();
        };
        document.getElementById('closeMsgBtn').onclick = function() {
          msgPopup.classList.add('hidden');
        };
        // Delete chat
        document.getElementById('deleteChatBtn').onclick = function() {
          if (confirm("Delete this chat?")) {
            delete messages[chatId];
            setMessages(messages);
            msgPopup.classList.add('hidden');
            if (typeof loadChats === "function") loadChats();
          }
        };
      }

      // Load all chats for user
      window.loadChats = function() {
        const user = getCurrentUser();
        if (!user) return;
        const messages = getMessages();
        const users = getUsers();
        const allChatsDiv = document.getElementById('allChats');
        allChatsDiv.innerHTML = '';
        let chatList = [];
        for (let chatId in messages) {
          if (chatId.includes(user.phone)) {
            const phones = chatId.split('_');
            const otherPhone = phones[0] === user.phone ? phones[1] : phones[0];
            const lastMsg = messages[chatId][messages[chatId].length - 1];
            chatList.push({ chatId, otherPhone, lastMsg });
          }
        }
        if (chatList.length === 0) {
          allChatsDiv.innerHTML = '<p>No messages yet.</p>';
          return;
        }
        chatList.sort((a, b) => new Date(b.lastMsg.time || 0) - new Date(a.lastMsg.time || 0));
        chatList.forEach(chat => {
          const chatUser = users.find(u => u.phone === chat.otherPhone);
          const div = document.createElement('div');
          div.className = 'chat-card';
          div.innerHTML = `
            <div class="chat-info">
              ${chatUser && chatUser.profilePic ? `<img class="result-pic" src="${chatUser.profilePic}" alt="Profile Pic">` : `<span class="result-emoji">${chatUser ? emoji(chatUser.gender) : ''}</span>`}
              <div class="chat-meta">
                <span>${chatUser ? chatUser.nickname : chat.otherPhone}</span>
                <span>Last: ${chat.lastMsg.text}</span>
              </div>
            </div>
            <button class="msgBtn" data-phone="${chat.otherPhone}">Open Chat</button>
            <button class="delChatBtn" data-chatid="${chat.chatId}">Delete Chat</button>
          `;
          allChatsDiv.appendChild(div);
        });
        // Message button logic (OPEN CHAT)
        allChatsDiv.querySelectorAll('.msgBtn').forEach(btn => {
          btn.onclick = function(e) {
            e.stopPropagation();
            openMsgPopup(btn.dataset.phone);
          };
        });
        // Delete chat button logic
        allChatsDiv.querySelectorAll('.delChatBtn').forEach(btn => {
          btn.onclick = function(e) {
            e.stopPropagation();
            if (confirm("Delete this chat?")) {
              const messages = getMessages();
              delete messages[btn.dataset.chatid];
              setMessages(messages);
              loadChats();
              // If popup is open for this chat, close it
              const msgPopup = document.getElementById('messagePopup');
              if (!msgPopup.classList.contains('hidden')) {
                const msgUserPhone = document.getElementById('msgUser').textContent;
                // If currently open chat matches deleted, close popup
                const chatUser = users.find(u => u.phone === btn.dataset.chatid.split('_')[0]) || users.find(u => u.phone === btn.dataset.chatid.split('_')[1]);
                if (chatUser && chatUser.nickname === msgUserPhone) {
                  msgPopup.classList.add('hidden');
                }
              }
            }
          };
        });
      }

      // Initial load
      loadChats();
    }
  </script>
</body>
</html>